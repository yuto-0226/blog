<!doctype html><html lang=en><head><title>用 C++ 模擬簡單的 8-bit cpu &ndash; Yuto's notes</title><meta name=description content="資工系的學生"><meta name=viewport content="width=device-width,initial-scale=1"><meta charset=utf-8><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.2/css/all.min.css integrity="sha512-1sCRPdkRXhBV2PBLUdRb4tMg1w2YPf37qatUFeS7zlBy7jJI8Lf4VHwWfZZfpXtYSLy85pkm9GaYVYMfw5BC1A==" crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/academicons/1.9.1/css/academicons.min.css integrity="sha512-b1ASx0WHgVFL5ZQhTgiPWX+68KjS38Jk87jg7pe+qC7q9YkEtFq0z7xCglv7qGIs/68d3mAp+StfC8WKC5SSAg==" crossorigin=anonymous><link rel=stylesheet href=https://example.org/css/palettes/base16-dark.css><link rel=stylesheet href=https://example.org/css/risotto.css><link rel=stylesheet href=https://example.org/css/custom.css></head><body><div class=page><header class=page__header><nav class="page__nav main-nav"><ul><h1 class=page__logo><a href=https://example.org/ class=page__logo-inner>Yuto's notes</a></h1><li class=main-nav__item><a class=nav-main-item href=https://example.org/pages/about/ title="About Me">About</a></li><li class=main-nav__item><a class=nav-main-item href=https://example.org/categories/ title=Categories>Categories</a></li><li class=main-nav__item><a class="nav-main-item active" href=https://example.org/posts/ title=Posts>Posts</a></li><li class=main-nav__item><a class=nav-main-item href=https://example.org/ title>Products</a></li><li class=main-nav__item><a class=nav-main-item href=https://example.org/tags/ title=Tags>Tags</a></li></ul></nav></header><section class=page__body><header class=content__header><h1>用 C++ 模擬簡單的 8-bit cpu</h1></header><div class=content__body><p>最近在看 beneater 的 8-bit cpu 想說用 C++ 寫看看練練手，所以就寫出來啦~
由於還沒對 CPU 理解得很徹底，只有把ALU做出來而已，以後再看看會不會在重寫一個哈哈。</p><h1 id=架構>架構</h1><ul><li>accumulator register</li><li>b register</li><li>instruction register</li><li>program counter</li></ul><h1 id=程式碼>程式碼</h1><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#75715e>#include</span><span style=color:#75715e>&lt;bits/stdc++.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span><span style=color:#75715e>&lt;stdio.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>using</span> byte<span style=color:#f92672>=</span><span style=color:#66d9ef>uint8_t</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>byte accumulator; <span style=color:#75715e>// accumulator register
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>byte b; <span style=color:#75715e>// register b
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>byte instruction; <span style=color:#75715e>// instruction register
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>byte counter; <span style=color:#75715e>// program counter
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>bool</span> negitive; <span style=color:#75715e>// negitive flag
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>bool</span> sign; <span style=color:#75715e>// sign flag
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>bool</span> HLT<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>byte memory[<span style=color:#ae81ff>256</span>]<span style=color:#f92672>=</span>{<span style=color:#ae81ff>0b11110000</span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>bool</span> isDebug<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>reset</span>(){
</span></span><span style=display:flex><span>    accumulator<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>    b<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>    counter<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>    instruction<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span>(<span style=color:#66d9ef>int</span> i<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>;i<span style=color:#f92672>&lt;</span><span style=color:#ae81ff>256</span>;i<span style=color:#f92672>++</span>) memory[i]<span style=color:#f92672>=</span><span style=color:#ae81ff>0b11110000</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>fetch</span>(){
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span>(HLT) <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>    instruction<span style=color:#f92672>=</span>memory[counter];
</span></span><span style=display:flex><span>    counter<span style=color:#f92672>+=</span><span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>STA</span>(){
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span>(isDebug) printf(<span style=color:#e6db74>&#34;%#4x STA: %#x</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>,counter,memory[counter]);
</span></span><span style=display:flex><span>    accumulator<span style=color:#f92672>=</span>memory[counter];
</span></span><span style=display:flex><span>    counter<span style=color:#f92672>+=</span><span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>STB</span>(){
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span>(isDebug) printf(<span style=color:#e6db74>&#34;%#4x STB: %#x</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>,counter,memory[counter]);
</span></span><span style=display:flex><span>    b<span style=color:#f92672>=</span>memory[counter];
</span></span><span style=display:flex><span>    counter<span style=color:#f92672>+=</span><span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>ADD</span>(){
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span>(isDebug) printf(<span style=color:#e6db74>&#34;%#4x ADD: %#x</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>,counter,memory[counter]);
</span></span><span style=display:flex><span>    b<span style=color:#f92672>=</span>memory[counter];
</span></span><span style=display:flex><span>    accumulator<span style=color:#f92672>+=</span>b;
</span></span><span style=display:flex><span>    counter<span style=color:#f92672>+=</span><span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>OUT</span>(){
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span>(isDebug) printf(<span style=color:#e6db74>&#34;%#4x OUT</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>,counter);
</span></span><span style=display:flex><span>    printf(<span style=color:#e6db74>&#34;%#4x</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>,accumulator);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>decode</span>(){
</span></span><span style=display:flex><span>    instruction<span style=color:#f92672>/=</span><span style=color:#ae81ff>16</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span>(isDebug) printf(<span style=color:#e6db74>&#34;%#4x instruction: %#x</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>,counter<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>,instruction);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>switch</span>(instruction){
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>case</span> <span style=color:#ae81ff>0x0001</span><span style=color:#f92672>:</span>    <span style=color:#75715e>// STA
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            STA();            
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>case</span> <span style=color:#ae81ff>0b0010</span><span style=color:#f92672>:</span>    <span style=color:#75715e>// LDA
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>case</span> <span style=color:#ae81ff>0b0011</span><span style=color:#f92672>:</span>    <span style=color:#75715e>// STB
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            STB();
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>case</span> <span style=color:#ae81ff>0b0100</span><span style=color:#f92672>:</span>    <span style=color:#75715e>// LDB
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>case</span> <span style=color:#ae81ff>0b0101</span><span style=color:#f92672>:</span>    <span style=color:#75715e>// ADD
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            ADD();
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>case</span> <span style=color:#ae81ff>0b1101</span><span style=color:#f92672>:</span>    <span style=color:#75715e>// OUT
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            OUT();
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>case</span> <span style=color:#ae81ff>0b1110</span><span style=color:#f92672>:</span>    <span style=color:#75715e>// HLT
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#66d9ef>if</span>(isDebug) printf(<span style=color:#e6db74>&#34;%#4x HLT</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>,counter);
</span></span><span style=display:flex><span>            HLT<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>case</span> <span style=color:#ae81ff>0b1111</span><span style=color:#f92672>:</span>    <span style=color:#75715e>// NOP
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#66d9ef>if</span>(isDebug) printf(<span style=color:#e6db74>&#34;%#4x NOP</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>,counter);
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>print_register</span>(byte reg){
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span>(<span style=color:#66d9ef>int</span> i<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>;i<span style=color:#f92672>&lt;</span><span style=color:#ae81ff>8</span>;i<span style=color:#f92672>++</span>){
</span></span><span style=display:flex><span>        printf(<span style=color:#e6db74>&#34;%u&#34;</span>,reg<span style=color:#f92672>/</span><span style=color:#ae81ff>128</span>);
</span></span><span style=display:flex><span>        reg<span style=color:#f92672>*=</span><span style=color:#ae81ff>2</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>print_memory</span>(byte address){
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span>(<span style=color:#66d9ef>int</span> i<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>;i<span style=color:#f92672>&lt;</span><span style=color:#ae81ff>8</span>;i<span style=color:#f92672>++</span>){
</span></span><span style=display:flex><span>        printf(<span style=color:#e6db74>&#34;%u&#34;</span>,memory[address]<span style=color:#f92672>/</span><span style=color:#ae81ff>128</span>);
</span></span><span style=display:flex><span>        memory[address]<span style=color:#f92672>*=</span><span style=color:#ae81ff>2</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>debug</span>(){
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span>(<span style=color:#f92672>!</span>isDebug) <span style=color:#66d9ef>return</span>; 
</span></span><span style=display:flex><span>    printf(<span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>%4#x  &#34;</span>,counter);
</span></span><span style=display:flex><span>    printf(<span style=color:#e6db74>&#34;%4#x</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>,memory[counter]);
</span></span><span style=display:flex><span>    printf(<span style=color:#e6db74>&#34;register:</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);
</span></span><span style=display:flex><span>    printf(<span style=color:#e6db74>&#34;%14s %4#x</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>,<span style=color:#e6db74>&#34;accumulator&#34;</span>,accumulator); 
</span></span><span style=display:flex><span>    printf(<span style=color:#e6db74>&#34;%14s %4#x</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>,<span style=color:#e6db74>&#34;b&#34;</span>,b);
</span></span><span style=display:flex><span>    printf(<span style=color:#e6db74>&#34;%14s %4#x</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>,<span style=color:#e6db74>&#34;instruction&#34;</span>,instruction);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>main</span>(){
</span></span><span style=display:flex><span>    reset();
</span></span><span style=display:flex><span>    memory[<span style=color:#ae81ff>0</span>]<span style=color:#f92672>=</span><span style=color:#ae81ff>0b00010000</span>;   <span style=color:#75715e>// LDA   
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    memory[<span style=color:#ae81ff>1</span>]<span style=color:#f92672>=</span><span style=color:#ae81ff>0b00000001</span>;
</span></span><span style=display:flex><span>    memory[<span style=color:#ae81ff>2</span>]<span style=color:#f92672>=</span><span style=color:#ae81ff>0b01010000</span>;   <span style=color:#75715e>// ADD
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    memory[<span style=color:#ae81ff>3</span>]<span style=color:#f92672>=</span><span style=color:#ae81ff>0b00000001</span>;
</span></span><span style=display:flex><span>    memory[<span style=color:#ae81ff>4</span>]<span style=color:#f92672>=</span><span style=color:#ae81ff>0b11010000</span>;   <span style=color:#75715e>// HLT
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    memory[<span style=color:#ae81ff>5</span>]<span style=color:#f92672>=</span><span style=color:#ae81ff>0b11100000</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>while</span>(<span style=color:#f92672>!</span>HLT){
</span></span><span style=display:flex><span>        <span style=color:#75715e>// fetch
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>//debug();
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        fetch();
</span></span><span style=display:flex><span>        decode();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></div><footer class=content__footer></footer></section><section class=page__aside><div class=aside__about><div class=aside__about><img class=about__logo src=https://example.org/images/rice.svg alt=Logo><h1 class=about__title>Yuto</h1><p class=about__description>資工系的學生</p></div><ul class=aside__social-links><li><a href=https://github.com/yuto-0226 rel=me aria-label=GitHub title=GitHub><i class="fa-brands fa-github" aria-hidden=true></i></a>&nbsp;</li><li><a href=mailto:wayne71112@gmail.com rel=me aria-label=Email title=Email><i class="fa-solid fa-envelope" aria-hidden=true></i></a>&nbsp;</li></ul></div><hr><div class=aside__content><p>2022-11-05</p></div></section><footer class=page__footer><p></p><br><br><p class=copyright>2023 © <a href=https://joeroe.io>Yuto</a></p><p class=advertisement>Powered by <a href=https://gohugo.io/>hugo</a> and <a href=https://github.com/joeroe/risotto>risotto</a>.</p></footer></div></body></html>